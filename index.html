<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ bot_name }} - Conversational AI</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  </head>
  <body>
    <div class="chat-container">
      <div class="chat-header">
        <h1>{{ bot_name }}</h1>
        <p>Your empathetic AI companion with memory</p>
        <div class="header-buttons">
          <button id="topic-button" title="Suggest a topic">üí° Topic</button>
          <button id="clear-button" title="Clear chat">üóëÔ∏è Clear</button>
        </div>
      </div>

      <div class="chat-messages" id="chat-messages">
        <div class="message bot-message">
          <div class="message-content">
            <p>
              Hello! I'm {{ bot_name }}, your friendly AI assistant. I'm here to
              have natural, engaging conversations and get to know you better
              over time. What would you like to talk about?
            </p>
          </div>
          <div class="message-time"></div>
        </div>
      </div>

      <!-- Thinking Indicator -->
      <div class="thinking-indicator" id="thinking-indicator">
        <div class="thinking-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <p>Aria is Thinking...</p>
      </div>

      <div class="chat-input-container">
        <textarea
          id="user-input"
          placeholder="Type your message here... (Shift+Enter for new line)"
          rows="1"
        ></textarea>
        <button id="send-button">Send</button>
      </div>
    </div>

    <script>
      const socket = io();
      const chatMessages = document.getElementById("chat-messages");
      const userInput = document.getElementById("user-input");
      const sendButton = document.getElementById("send-button");
      const thinkingIndicator = document.getElementById("thinking-indicator");
      const topicButton = document.getElementById("topic-button");
      const clearButton = document.getElementById("clear-button");

      // Initially hide the thinking indicator
      thinkingIndicator.style.display = "none";

      // Store conversation history for local context
      let conversationHistory = [];

      // Auto-resize textarea
      userInput.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = this.scrollHeight + "px";
      });

      // Send message on button click
      sendButton.addEventListener("click", sendMessage);

      // Request topic suggestion
      topicButton.addEventListener("click", function () {
        socket.emit("request_topic");
      });

      // Clear chat history
      clearButton.addEventListener("click", function () {
        if (
          confirm(
            "Clear all messages? This won't delete your saved preferences."
          )
        ) {
          chatMessages.innerHTML = "";
          conversationHistory = [];
          addMessage("Chat cleared. What would you like to talk about?", "bot");
        }
      });

      // Send message on Enter key (but allow Shift+Enter for new line)
      userInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      function sendMessage() {
        const message = userInput.value.trim();
        if (message) {
          // Add user message to chat
          addMessage(message, "user");
          conversationHistory.push({ type: "user", content: message });

          // Send to server
          socket.emit("user_message", { message: message });

          // Clear input
          userInput.value = "";
          userInput.style.height = "auto";

          // Disable input while processing
          userInput.disabled = true;
          sendButton.disabled = true;
        }
      }

      function addMessage(message, sender) {
        const messageElement = document.createElement("div");
        messageElement.className = `message ${sender}-message`;

        const messageContent = document.createElement("div");
        messageContent.className = "message-content";

        const messageParagraph = document.createElement("p");
        messageParagraph.textContent = message;

        messageContent.appendChild(messageParagraph);
        messageElement.appendChild(messageContent);

        const messageTime = document.createElement("div");
        messageTime.className = "message-time";
        messageTime.textContent = new Date().toLocaleTimeString();
        messageElement.appendChild(messageTime);

        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Handle bot responses
      socket.on("bot_response", function (data) {
        // Hide thinking indicator
        thinkingIndicator.style.display = "none";

        // Re-enable input
        userInput.disabled = false;
        sendButton.disabled = false;
        userInput.focus();

        addMessage(data.message, "bot");
        conversationHistory.push({ type: "bot", content: data.message });
      });

      // Show thinking indicator when processing starts
      socket.on("thinking_start", function () {
        thinkingIndicator.style.display = "flex";
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });

      // Focus input on load
      window.addEventListener("load", function () {
        userInput.focus();
      });
    </script>
  </body>
</html>
